<% include("../header.ejs"); %>

<h2>RSVP List</h2>
<form action="/events/<%= eventId %>/attendance" method="POST">
    <% attendance.forEach(function(attendee) { %>
    <% if (attendee.attendInfo.didRSVP) { %>
    <input name="<%= attendee.attendInfo.userId %>" id="<%= attendee.attendInfo.userId %>" value="true"
        type="checkbox" />
    <label for="<%=attendee.attendInfo.userId %>" class="name"><%= attendee.email %></label><br />
    <% } %>
    <% }); %>

    <h2>Other</h2>
    <% attendance.forEach(function(attendee) { %>
    <% if (attendee.attendInfo.didRSVP === false && attendee.attendInfo.didAttend === true) { %>
    <input name="<%= attendee.attendInfo.userId %>" id="<%= attendee.attendInfo.userId %>" value="true"
        type="checkbox" />
    <label for="<%=attendee.attendInfo.userId %>" class="name"><%= attendee.email %></label><br />
    <% } %>
    <% }); %>

    <input type='text' id='addAttendeeText' name='addAttendeeText' />
    <button id='addAttendeeButton' name='addAttendeeButton'>Add</button>
    <input type='submit' value='Save All' />
    <div id='attendeeListDiv'></div>
</form>

<script>
    var attendees = [];

    var attendeeInput = document.querySelector('#addAttendeeText');
    var addAttendeeButton = document.querySelector('#addAttendeeButton');
    var attendeeListDiv = document.querySelector('#attendeeListDiv');

    addAttendeeButton.addEventListener("click", (e) => {
        e.preventDefault();

        for (let i = 0; i < attendees.length; i++) {
            if (attendees[i].trim() === attendeeInput.value.trim()) {
                return;
            }
        }

        fetch("/attendees/" + attendeeInput.value)
            .then(response => response.json())
            .then(data => {
                if (data.isValidEmail === true) {
                    createAttendeeDiv(data.id, attendeeInput.value);
                }
            });
    });

    function createAttendeeDiv(userId, email) {

        var div = document.createElement('div');

        var checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = userId;
        checkbox.name = userId;
        checkbox.checked = true;
        checkbox.value = true;

        var emailText = document.createElement('label');
        emailText.innerHTML = email;
        emailText.for = userId;

        div.appendChild(checkbox);
        div.appendChild(emailText);
        attendeeListDiv.appendChild(div);

        attendees.push(email);
    }
</script>

<% include("../footer.ejs"); %>